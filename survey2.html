<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>äººå·¥æ™ºèƒ½ä¿¡ä»»è°ƒæŸ¥é—®å· - ç¬¬äºŒéƒ¨åˆ†</title>
    <link rel="stylesheet" href="css/styles.css">
    <!-- æ€§èƒ½ä¼˜åŒ– -->
    <link rel="preload" href="css/styles.css" as="style">
    <link rel="preconnect" href="https://www.gstatic.com">
    <script type="module">
        import { db, auth } from './js/firebase-config.js';
        import { surveyManager, initProgress } from './js/survey.js';
        
        // åˆå§‹åŒ–ç®¡ç†å®ä¾‹
        window.surveyManager = surveyManager;
        window.auth = auth;
    </script>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>äººå·¥æ™ºèƒ½æŠ€æœ¯è¯´æ˜</h1>
            <div class="progress-bar" role="progressbar" 
                 aria-valuemin="0" aria-valuemax="100" aria-valuenow="24">
                <div class="progress"></div>
            </div>
        </div>

        <form id="techSurvey" class="questionnaire-part" aria-label="æŠ€æœ¯è¯´æ˜éƒ¨åˆ†">
            <!-- æŠ€æœ¯è¯´æ˜å¡ç‰‡ï¼ˆä¿æŒåŸå†…å®¹ï¼‰ -->
            <section class="info-card ai-intro" aria-labelledby="ai-title">
                <div class="icon-box" aria-hidden="true">ğŸ¤–</div>
                <h2 id="ai-title">äººå·¥æ™ºèƒ½ï¼ˆAIï¼‰</h2>
                <p>äººå·¥æ™ºèƒ½æ˜¯æŒ‡è®¡ç®—æœºç³»ç»Ÿé€šè¿‡åˆ†æç¯å¢ƒæ•°æ®ï¼Œæ¨¡æ‹Ÿäººç±»æ€ç»´è¿›è¡Œè‡ªä¸»å†³ç­–çš„æŠ€æœ¯ã€‚å®ƒå€ŸåŠ©å„ç±»ä¼ æ„Ÿå™¨è·å–ä¿¡æ¯ï¼Œè¿ç”¨æ™ºèƒ½ç®—æ³•è¯†åˆ«è§„å¾‹ï¼Œæœ€ç»ˆè¾“å‡ºæœ€ä¼˜è¡ŒåŠ¨æ–¹æ¡ˆã€‚è¿™é¡¹æŠ€æœ¯æ­£åœ¨æ¨åŠ¨åŒ»ç–—è¯Šæ–­ã€åŸå¸‚ç®¡ç†ã€å·¥ä¸šåˆ¶é€ ç­‰é¢†åŸŸçš„æ™ºèƒ½åŒ–å‡çº§ã€‚</p>
            </section>

            <div class="button-container">
                <button type="submit" class="btn" aria-label="ç»§ç»­ä¸‹ä¸€é¡µ">
                    ç»§ç»­
                </button>
            </div>
        </form>
    </div>

    <script type="module">
        import { db, auth } from './js/firebase-config.js';
        import { surveyManager, initProgress } from './js/survey.js';
        import { showError } from './js/helpers.js';
        import { doc, runTransaction, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        // ç‰ˆæœ¬ç™½åå•ï¼ˆæ–°å¢æ ¡éªŒï¼‰
        const VALID_PAGES = [
            'part111', 'part112', 'part113', 'part114',
            'part115', 'part116', 'part117', 'part118'
        ];

        document.addEventListener('DOMContentLoaded', async () => {
          try {
            // å¢å¼ºè®¤è¯æµç¨‹
            const initAuth = () => new Promise((resolve, reject) => {
              const unsubscribe = onAuthStateChanged(auth, async user => {
                unsubscribe();
                if (user) return resolve(user);
                try {
                  await signInAnonymously(auth);
                  resolve(auth.currentUser);
                } catch (error) {
                  reject(error);
                }
              });
            });

            // åˆå§‹åŒ–æµç¨‹
            await initAuth();
            initProgress(24);

            // ç»‘å®šè¡¨å•æäº¤
            document.getElementById('techSurvey').addEventListener('submit', async (e) => {
              e.preventDefault();
              
              try {
                // éªŒè¯ç”¨æˆ·çŠ¶æ€
                const user = auth.currentUser;
                if (!user || user.isAnonymous === false) {
                  throw new Error('æ— æ•ˆç”¨æˆ·ä¼šè¯');
                }

                // è®°å½•äº¤äº’æ•°æ®
                await Promise.all([
                  surveyManager.recordPageTime('tech_intro'),
                  surveyManager.recordAction('tech_page_submit')
                ]);

                // æ‰§è¡Œåˆ†é…äº‹åŠ¡
                const allocationRef = doc(db, 'surveyAllocations', 'pageCounts');
                let targetPage;

                await runTransaction(db, async (transaction) => {
                  const docSnap = await transaction.get(allocationRef);
                  if (!docSnap.exists()) throw new Error('åˆ†é…é…ç½®æœªåˆå§‹åŒ–');

                  const allocations = docSnap.data();
                  const availablePages = VALID_PAGES.filter(p => allocations[p] < 30);

                  if (availablePages.length === 0) {
                    throw new Error('æ‰€æœ‰é—®å·ç‰ˆæœ¬å·²æ»¡å‘˜ï¼Œè¯·ç¨åå†è¯•');
                  }

                  // åŠ æƒéšæœºåˆ†é…ï¼ˆä¼˜åŒ–ç‚¹ï¼‰
                  targetPage = availablePages.sort(() => 0.5 - Math.random())[0];
                  transaction.update(allocationRef, {
                    [targetPage]: allocations[targetPage] + 1
                  });
                });

                // éªŒè¯é¡µé¢æœ‰æ•ˆæ€§ï¼ˆæ–°å¢æ ¡éªŒï¼‰
                if (!VALID_PAGES.includes(targetPage)) {
                  throw new Error(`æ— æ•ˆé—®å·ç‰ˆæœ¬ï¼š${targetPage}`);
                }

                // è®°å½•ç”¨æˆ·è·¯å¾„
                await setDoc(doc(db, 'userAllocations', user.uid), {
                  uid: user.uid,
                  page: targetPage,
                  timestamp: new Date(),
                  userAgent: navigator.userAgent
                }, { merge: true });

                // æ‰§è¡Œè·³è½¬
                window.location.href = `survey-${targetPage}.html`;

              } catch (error) {
                const errorMessage = error.message.includes('æ»¡å‘˜') ? 
                  'å½“å‰å‚ä¸äººæ•°å·²æ»¡ï¼Œè¯·24å°æ—¶åå†æ¬¡è®¿é—®' : 
                  `ç³»ç»Ÿé”™è¯¯ï¼ˆ${error.message}ï¼‰`;
                showError(errorMessage);
                console.error('åˆ†é…é”™è¯¯:', error);
              }
            });

          } catch (error) {
            showError('é¡µé¢åˆå§‹åŒ–å¤±è´¥ï¼Œè¯·æ¸…é™¤ç¼“å­˜åé‡è¯•');
            console.error('åˆå§‹åŒ–é”™è¯¯:', error);
          }
        });
    </script>
</body>
</html>