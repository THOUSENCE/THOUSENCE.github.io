<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>问卷提交 - 人工智能信任调查</title>
  <link rel="stylesheet" href="css/styles.css">
  <!-- 性能优化 -->
  <link rel="preload" href="css/styles.css" as="style">
  <link rel="preconnect" href="https://www.gstatic.com">
  <script type="module">
    // 核心依赖
    import { db } from './js/firebase-config.js';
    import { surveyManager, initProgress } from './js/survey.js';
    
    // 初始化管理实例
    window.surveyManager = surveyManager;
  </script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>问卷提交确认</h1>
      <div class="progress-bar" role="progressbar"
           aria-valuemin="0" aria-valuemax="100" aria-valuenow="100">
        <div class="progress"></div>
      </div>
    </div>

    <main class="completion-box" role="main">
      <div class="checkmark" aria-hidden="true">✓</div>
      <h2 class="completion-title">问卷已完成！</h2>
      <div class="appreciation-text">
        <p>衷心感谢您参与本次调查研究！您的每个答案都对我们的研究具有重要意义。</p>
        <p>我们承诺将对所有数据严格保密，仅用于学术研究目的。</p>
      </div>
      
      <form id="finalSubmit" class="questionnaire-part"
            aria-labelledby="submit-heading">
        <div class="consent-check">
          <label>
            <input type="checkbox" name="consent" required
                   aria-describedby="consent-desc">
            我确认所有回答均为真实意愿表达
          </label>
        </div>

        <div class="button-container">
          <button type="submit" class="btn submit-btn"
                  aria-label="最终提交问卷">
            确认提交
          </button>
        </div>
      </form>
      <div id="errorContainer" class="error-container" style="display:none;"></div>
    </main>
  </div>

  <!-- 页面专属逻辑 -->
  <script type="module">
    import { surveyManager, initProgress } from './js/survey.js';
    import { showProgress, showError } from './js/helpers.js';
  
    document.addEventListener('DOMContentLoaded', async () => {
      try {
        // 初始化最终页进度
        initProgress(100);
  
        // 执行初始化（例如：获取IP等）
        await surveyManager.init();
  
        // 绑定最终提交表单
        const form = document.getElementById('finalSubmit');
        const errorContainer = document.getElementById('errorContainer');
  
        form.addEventListener('submit', async (e) => {
          e.preventDefault();
  
          try {
            const progress = showProgress('正在提交最终数据...', 'info');
  
            // 执行最终提交
            const result = await surveyManager.submitFinal();
  
            progress.close();

            if (result.success) {
              progress.update('提交成功！正在跳转...');
              setTimeout(() => {
                progress.close();
                window.location.href = 'thanks.html';
              }, 1500);
            } else {
              if (result.valid === false) {
                // 显示具体的错误信息
                errorContainer.innerHTML = `<p class="error-message">提交失败：${result.reasons.join('，')}</p>`;
                errorContainer.style.display = 'block';
                const reasons = result.reasons.join("，");
                showError(`未通过验证: ${reasons}`);
                progress.close();

                setTimeout(() => {
                window.location.href = 'disqualified.html';
                }, 2000);
              } else {
                // 其他错误情况
                showError(`最终提交失败: ${result.error ? result.error : '未知错误'}`);
              }
            }
  
          } catch (error) {
            showError('提交过程中发生意外错误');
            console.error('最终提交异常:', error);
          }
        });
  
      } catch (error) {
        showError('页面初始化失败，请刷新重试');
        console.error('最终页错误:', error);
      }
    });
  </script>
</body>
</html>
